function resizeForMobile(){currView="small",$("body").removeClass("large_view"),$("#top-bar").find('a[href!="#/search"]').show(0),$("#search-btn").removeClass("active"),$("div[id^=space-]").css("margin-top","0")}function resizeForDesktop(){currView="large",$("body").addClass("large_view"),$("#top-bar").find('a[href!="#/search"]').hide(0),$("#map").show(0),$("#search-btn").addClass("active"),$("#search").show(),$("div[id^=space-]").css("margin-top",$("#top-bar").outerHeight())}function switchView(e,t){if("/list"==oldView&&(listScroll=Number($(window).scrollTop())),void 0==e&&(e=initialView),closeSpaces(),"small"==currView&&$(".view-container").css("position",""),-1==e.indexOf("/")&&$("#"+e).length>0)"small"==currView&&(console.log(e),$(".view-container").css("display","none"),$("a").removeClass("active"),$('a[href="#/'+e+'"]').addClass("active"),$("#"+e).fadeIn({duration:300,start:function(){"map"==e&&(google.maps.event.trigger(map,"resize"),$(window).scrollTop(0)),mapViewed||(systemEvent=!0,centerOnLocation?map.setCenter(userLoc):map.setCenter(loc))},progress:function(){"list"==e&&$(window).scrollTop(listScroll),"map"==e&&openPoints.length>0&&(new google.maps.event.trigger(points[openPoints[0]].marker,"click"),systemEvent=!0,map.setZoom(currentZoom))}}));else if(-1!==e.indexOf("space")){"small"==currView&&$(".view-container").css("position","fixed");var a=e.split("/");loadSpace({id:a[1],name:a[2].replace("-"," ")})}$(".loading-cover").length>0&&$(".loading-cover").addClass("loaded").delay(500).fadeOut(300,function(){$(this).remove()})}function loadSpace(e){var t={},a;$.extend(t,e),a=findMarkers(points,{id:t.id}).spaces,1==a.length?showSpace(a[0]):0==a.length&&$.ajax({url:"/assets/data/unloaded-space.json",dataType:"json",data:{id:t.id}}).done(function(e){"array"==$.type(e)&&(e=e[0]),showSpace(e)})}function showSpace(e){var t=$("<div />").css({"margin-top":$(window).height()}).attr("id","space-"+e.id).addClass("space-container").append(parseTemplate("spaceDetail",e)).insertAfter("#list");"large"==currView?(t.width($list.width()).css("left",$list.offset().left),t.animate({"margin-top":$("#top-bar").outerHeight(!0)},300)):t.animate({"margin-top":0},300,function(){t.find(".title").css("position","fixed"),t.css("overflow","auto")})}function closeSpaces(){var e=$("div[id^=space-]");if(e.css("overflow","hidden").find(".title").removeAttr("style"),$("div[id^=space-]").animate({"margin-top":$(window).height()},300,function(){$(this).remove(),"large"==currView&&$("#list").css("display","block")}),openPoints.length>0)for(var t=0;t<openPoints.length;t++)void 0!==points[openPoints[t]].mapSummary&&points[openPoints[t]].mapSummary.close(),points[openPoints[t]].marker.icon.fillColor=inactiveColor,points[openPoints[t]].marker.setMap(map),openPoints.splice(t,1);systemEvent=!0,map.setZoom(currentZoom),systemEvent=!0,map.setCenter(currentLoc)}function resetViews(){mapOptions.center=currentLoc,mapOptions.zoom=currentZoom,map=new google.maps.Map(document.getElementById("map"),mapOptions),$("#list").html(""),google.maps.event.addListener(map,"center_changed",function(e){if(!systemEvent&&0==$("div[id^=space-]").length){var t=map.getCenter();currentLoc.lat=t.G,currentLoc.lng=t.K}setTimeout(function(){systemEvent=!1},300)}),google.maps.event.addListener(map,"bounds_changed",function(){systemEvent||0!=$("div[id^=space-]").length||(currentZoom=map.getZoom(),pointsInView()),setTimeout(function(){systemEvent=!1},300)})}function loadSpaces(e){var t={queryString:"",reset:!1};$.extend(t,e),resetViews(),console.log(spacesRequest),spacesRequest&&4!=spacesRequest.readyState&&(console.log("abort request"),spacesRequest.abort()),spacesRequest=$.ajax("https://uoc-spacefinder.herokuapp.com/spaces.json?callback=?",{cache:!1,dataType:"json",method:"GET",data:t.queryString}).done(function(e){return points=e,distCount=0,0==points.length?(loadMap(),loadList(),"function"==typeof t.callback&&t.callback(),!1):void(getLocation?$.each(points,function(e,a){null!==points[e].lat&&null!==points[e].lng?getDistance(userLoc,{lat:Number(points[e].lat),lng:Number(points[e].lng)},function(a){points[e].distance=a,distCount++,distCount==points.length&&(t.reset||loadSearch(),orderSpaces(),loadMap(),loadList(),"function"==typeof t.callback&&t.callback())}):(distCount++,distCount==points.length&&(t.reset||loadSearch(),orderSpaces(),loadMap(),loadList(),"function"==typeof t.callback&&t.callback())),points[e].link="#/space/"+points[e].id+"/"+points[e].name.replace(" ","-")}):($.each(points,function(e,t){points[e].link="#/space/"+points[e].id+"/"+points[e].name.replace(" ","-")}),t.reset||loadSearch(),orderSpaces(),loadMap(),loadList(),"function"==typeof t.callback&&t.callback()))})}function showLoginScreen(e,t){var a=$(e),i={};$.extend(i,t),$("<div />").addClass("login-screen").html(parseTemplate("login",i)).appendTo(a),$(a.parents("div")[a.parents("div").length-1]).scrollTop(0)}function loadSearch(){$.ajax("https://uoc-spacefinder.herokuapp.com/spaces/filters.json?callback=?",{cache:!1,dataType:"json",method:"GET"}).done(function(e){$("#search").append(parseTemplate("search",e))})}function checkMarker(e,t){var a=!0;return $.each(t,function(t,i){return e[t]!=i?(a=!1,!1):void 0}),a}function findMarkers(e,t){var a={spaces:[]};return $.each(e,function(i){checkMarker(e[i],t)&&(e[i]._jsid=i,a.spaces.push(e[i]))}),a.spaces.length>1&&(a.lat=a.spaces[0].lat,a.lng=a.spaces[0].lng,""!==a.spaces[0].library?a.name=a.spaces[0].library:a.name=a.spaces[0].address),a}function loadMap(e){var t={inactiveColor:inactiveColor,activeColor:activeColor};$.extend(t,e),$.each(points,function(e){if(void 0!==points[e].marker)return!0;if(null==points[e].lat||null==points[e].lng)return!0;"string"==$.type(points[e].lat)&&(points[e].lat=Number(points[e].lat)),"string"==$.type(points[e].lng)&&(points[e].lng=Number(points[e].lng));for(var a=findMarkers(points,{lat:points[e].lat,lng:points[e].lng}),i=a.spaces.length>1?!0:!1,n=new google.maps.Marker({position:{lat:Number(points[e].lat),lng:Number(points[e].lng)},icon:i?multiMarkerSymbol:markerSymbol}),o=0;o<a.spaces.length;o++)points[a.spaces[o]._jsid].marker=n;points[e].marker=n;var s;i?(points[e].spaces=a.spaces,points[e].template="mapMulti",s=parseTemplate("mapMulti",points[e])):(points[e].template="mapSingle",s=parseTemplate("mapSingle",points[e]));var l=new InfoBubble({content:s,shadowStyle:0,padding:0,backgroundColor:"rgba(0,0,0,0.8)",borderRadius:0,arrowSize:10,borderWidth:0,padding:12,disableAutoPan:!1,hideCloseButton:!1,backgroundClassName:"map-info-bubble",disableAnimation:!0,arrowStyle:0});points[e].mapSummary=l,n.setMap(map),google.maps.event.addListener(n,"click",function(){if(systemEvent=!0,openPoints.length>0)for(var a=0;a<openPoints.length;a++)points[openPoints[a]].mapSummary.close(),points[openPoints[a]].marker.icon.fillColor=inactiveColor,points[openPoints[a]].marker.setMap(map),openPoints.splice(a,1);if(0==$("#bubble-"+points[e].id).length)setTimeout(function(){systemEvent=!0;var t=$("#bubble-"+points[e].id).parent();$("#bubble-"+points[e].id).remove(),t.parents(".infoBubble").css("width",.8*$("#map").width()),points[e].mapSummary.open(),$(t).append(parseTemplate(points[e].template,points[e])),t.parents(".infoBubble").css("width",.8*$("#map").width())},100);else{var i=$("#bubble-"+points[e].id).parent();i.parents(".infoBubble").css("width",.8*$("#map").width())}l.open(map,n),this.icon.fillColor=t.activeColor,this.setMap(map),openPoints.push(e)}),google.maps.event.addListener(l,"closeclick",function(){n.icon.fillColor=t.inactiveColor,n.setMap(map),openPoints=[]})}),"function"==typeof t.callback&&t.callback()}function loadList(e){var t={inactiveColor:"rgba(0,0,0,0.6)",activeColor:"#e2637c"};return $.extend(t,e),0==points.length?($list.append($("<div />").html("There are no spaces to show with the current search criteria.").addClass("empty-list")),!0):($.each(points,function(e){var t=parseTemplate("list",points[e]);$list.append(t)}),$(".list-space>h2>.library").each(function(e,t){var a=$(this).next(".address");""==$(this).html()?a.length>0&&""!==a.html()&&(a.removeClass("hidden").html(a.html().split(/\r\n|\r|\n|,/g)[0]),$(this).remove()):a.remove()}),$(".list-space").each(function(){var e=$(this).find(".description").html();$(this).hover(function(e){if(e.preventDefault(),e.stopPropagation(),!$(this).hasClass("hover")){$(this).addClass("hover");var t=findMarkers(points,{id:$(this).data("id")}).spaces[0];void 0!==t.marker&&void 0!==t.marker.icon&&(t.marker.icon.fillColor=activeColor,t.marker.setMap(map))}},function(e){if(e.preventDefault(),e.stopPropagation(),$(this).hasClass("hover")){$(this).removeClass("hover");var t=findMarkers(points,{id:$(this).data("id")}).spaces[0];$(this).hasClass("clicked")||void 0!==t.marker&&void 0!==t.marker.icon&&(t.marker.icon.fillColor=inactiveColor,t.marker.setMap(map))}}).on("click",function(e){e.preventDefault(),$this=$(this),$this.addClass("clicked"),setTimeout(function(){$this.removeClass("clicked")},400),$this.trigger("mouseout"),window.location.hash=$(this).data("link")})}),void("function"==typeof t.callback&&t.callback()))}function loadTemplates(e){var t={},a=0;$.extend(t,e),$.each(templates,function(e){a++,$.ajax({url:templates[e].url,dataType:"html"}).done(function(t){templates[e].template=t,a--})});var i=setInterval(function(){"function"==typeof t.callback&&0>=a&&(clearInterval(i),t.callback())},10)}function parseTemplate(e,t,a){if(void 0==e)return!1;var i=new RegExp("(#{.*\\[.*\\].*})","g"),n,o,s,l=null,r=null,c=null,p=null;if(o=1==a?e:templates[e].template,n=o.match(i),null!==n)for(var d=0;d<n.length;d++){var i=new RegExp("(#{(.*)\\[(.*)\\](.*?)})","g"),u=i.exec(n[d]);if(null!==u&&u!==u[4]!==void 0&&(l=u[4].match(/.*limit="(.*)".*/),l=null!==l?Number(l[1]):null),null!==u&&void 0!==u[2]){var m=convertToValue(u[3],t[u[2]],{limit:l,icon:r,attr:c});o=o.replace(u[1],m)}}if(i=new RegExp("(#{(.*?)})","g"),s=o.match(i),null!==s)for(var d=0;d<s.length;d++){l=s[d].match(/.*\(.*limit="(.*)".*/),value=s[d].match(/.*\(.*value="(.*)".*/),c=s[d].match(/.*\(.*attr="(.*)".*/),r=s[d].match(/.*\(.*icon.*/),p=s[d].match(/.*\(.*raw.*/),null!==r&&(r=!0),null!==p&&(p=!0),null!==l&&(l=Number(l[1])),null!==c&&(c=c[1]),null!==value&&(value=value[1]);var h="";h=null!==l||null!==r||null!==c||null!==value||null!==p?s[d].match(/#{(.*)\(.*}/):s[d].match(/#{(.*)}/);var m=convertToValue(s[d],t[h[1]],{limit:l,icon:r,attr:c,value:value,raw:p});o=o.replace(s[d],m)}return o}function convertToValue(e,t,a){if("array"==$.type(t)){for(var i="",n=0;n<t.length;n++){var o=e;if("object"==$.type(t[n])||"array"==$.type(t[n]))o=a.raw?t[n]:parseTemplate(e,t[n],!0);else{var s=searchArray(iconMap,t[n]);-1!==s?(o=o.replace(/#{value}/g,iconMap[s][1]),o=o.replace(/#{attr}/g,iconMap[s][0].replace(/ /g,"-")),o=o.replace(/#{icon}/g,iconMap[s][2])):(o=o.replace(/#{value}/g,t[n].replace(/(.*?)/,"")),o=o.replace(/#{attr}/g,t[n]))}if(i+=o,null!==a.limit&&n>=a.limit-1)break}return i}if("object"==$.type(t)){var i=e;return a.raw?JSON.stringify(t):(null!==a.value?i=null!==a.limit?t[a.value].substr(0,a.limit):t[a.value]:$.each(t,function(e,t){i=null!==a.limit?i.replace("/#{"+e+".*}/g",String(t).substr(0,a.limit)):i.replace("/#{"+e+".*}/g",t)}),i)}if(void 0!==t&&null!==t&&"null"!==t){if(null!==a.limit&&(t=String(t).substr(0,a.limit)),null!==a.attr&&(t=String(t).replace(" ",a.attr)),a.icon){var s=searchArray(iconMap,t);-1!==s&&(t=iconMap[s][2])}return t}return""}function searchArray(e,t){for(var a=-1,i=0;i<e.length;i++)if("array"==$.type(e[i])){for(var n=0;n<e[i].length;n++)if(e[i][n]==t){a=i;break}if(-1!==a)break}else if(e[i]==t){a=i;break}return a}function getDistance(e,t,a){var i=new google.maps.DistanceMatrixService;if("array"!==$.type(e)){var n=[];n.push(e),e=n}if("array"!==$.type(t)){var n=[];n.push(t),t=n}i.getDistanceMatrix({origins:e,destinations:t,unitSystem:google.maps.UnitSystem.IMPERIAL,travelMode:google.maps.TravelMode.WALKING},function(e,t){return"OK"!=t?"":void("function"==$.type(a)&&(void 0!==e.rows[0].elements[0].distance?a(e.rows[0].elements[0].distance.text):a()))})}function loginCallback(e){"success"==e.status&&("object"==$.type(e)&&(userDetails=e),$(window).trigger("login_callback"))}function orderSpaces(){points.sort(function(e,t){return aNum=parseFloat(e.distance),bNum=parseFloat(t.distance),void 0==e.distance?1:void 0==t.distance?-1:(-1!==e.distance.indexOf("ft")&&(aNum=Number("0.0"+parseFloat(e.distance))),-1!==t.distance.indexOf("ft")&&(bNum=Number("0.0"+parseFloat(t.distance))),aNum>bNum?1:aNum<bNum?-1:0)})}function pointsInView(){for(var e=map.getBounds(),t=[new google.maps.LatLng(e.Ia.G,e.Ca.G),new google.maps.LatLng(e.Ia.j,e.Ca.G),new google.maps.LatLng(e.Ia.j,e.Ca.j),new google.maps.LatLng(e.Ia.G,e.Ca.j)],a=new google.maps.Polygon({paths:t,strokeColor:"#FF0000",strokeOpacity:.8,strokeWeight:3,fillColor:"#FF0000",fillOpacity:.35}),i=0;i<points.length;i++)if(null!==points[i].lat||null!==points[i].lng){var n=new google.maps.LatLng(points[i].lat,points[i].lng),o=google.maps.geometry.poly.containsLocation(n,a);o?$list.find("[data-id="+points[i].id+"]").slideDown(300):$list.find("[data-id="+points[i].id+"]").slideUp(300)}}var map,$list=$("#list"),openPoints=[],loc={lat:52.205575,lng:.121682},userLoc={lat:0,lng:0},userDetails=null,getLocation=!0,centerOnLocation=!1,points=[],listScroll=0,currView="small",currWidth=0,loginWindow,currentZoom=14,currentLoc=loc,systemEvent=!1,spacesRequest=null,mapOptions={center:loc,zoom:20,disableDefaultUI:!0,zoomControl:!0,zoomControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT}},oldView=void 0,currViewHash=void 0,templates={list:{url:"/assets/templates/list-space.html",template:""},mapSingle:{url:"/assets/templates/map-single-space.html",template:""},mapMulti:{url:"/assets/templates/map-multi-space.html",template:""},spaceDetail:{url:"/assets/templates/space-detail.html",template:""},search:{url:"/assets/templates/search.html",template:""},addTip:{url:"/assets/templates/add-tip.html",template:""},addTag:{url:"/assets/templates/add-tag.html",template:""},spaceTip:{url:"/assets/templates/space-tip.html",template:""},login:{url:"/assets/templates/login.html",template:""}},inactiveColor="rgba(0,0,0,1)",activeColor="#00b1c1",initialView="map",view="",mapViewed=!1,markerSymbol={path:"M0-30.5c-5.7,0-10.2,4.6-10.2,10.2C-10.2-14.6,0,0,0,0s10.2-14.6,10.2-20.2C10.2-25.9,5.7-30.5,0-30.5z M0-17.7c-1.6,0-3-1.3-3-3s1.3-3,3-3s3,1.3,3,3S1.6-17.7,0-17.7z",fillColor:inactiveColor,fillOpacity:1,scale:1,strokeWeight:0},multiMarkerSymbol={path:"M0-28.5c-5.7,0-10.2,4.6-10.2,10.2C-10.2-12.6,0,0,0,0s10.2-12.6,10.2-18.2C10.2-23.9,5.7-28.5,0-28.5z M5.2-17.8h-4v4h-2.4v-4h-4v-2.4h4v-4h2.4v4h4V-17.8z",fillColor:inactiveColor,fillOpacity:1,scale:1,strokeWeight:0};$().ready(function(){$("#search-btn").on("click touchstart",function(e){"large"==currView&&(e.preventDefault(),$(this).hasClass("active")?($("#search").hide(0),$(this).removeClass("active")):($("#search").show(0),$(this).addClass("active")),$("div[id^=space-]").css({left:$list.offset().left,width:$list.width()}),systemEvent=!0,google.maps.event.trigger(map,"resize"))});var e=initialView;if($(window).on("hashchange",function(e){return void 0!==e.originalEvent.oldURL?oldView=e.originalEvent.oldURL.split("#")[1]:void 0!==currViewHash&&(oldView=currViewHash),console.log(oldView),currViewHash=view=window.location.hash.substr(1),"/"!=view.substr(0,1)?!1:("/"==view&&(window.location.hash="/"+initialView),view=view.substr(1),console.log("switch view - "+view),void switchView(view))}),""!==window.location.hash&&initialView!==window.location.hash){if(view=window.location.hash.substr(1),"/"!=view.substr(0,1))return!1;view=view.substr(1),e=view}loadTemplates({data:templates,callback:function(){"geolocation"in navigator&&getLocation&&0==userLoc.lat&&0==userLoc.lng?navigator.geolocation.getCurrentPosition(function(t){userLoc.lat=t.coords.latitude,userLoc.lng=t.coords.longitude,loadSpaces({callback:function(){switchView(e)}})},function(){getLocation=!1,loadSpaces({callback:function(){switchView(e)}})},{enableHighAccuracy:!1,timeout:5e3,maximumAge:0}):loadSpaces({callback:function(){switchView(e)}})}}),moment.locale("en",{relativeTime:{future:"in %s",past:"%s",s:"seconds",m:"a minute",mm:"%d m",h:"an hour",hh:"%d h",d:"a day",dd:"%d d",M:"a month",MM:"%d m",y:"a year",yy:"%d y"}}),$(window).on("resize",function(e){systemEvent=!0,e.preventDefault(),currWidth=$(window).width(),$("div[id^=space-]").width($list.width()).css("left",$list.offset().left),1e3>currWidth&&"small"!==currView?(resizeForMobile(),$(window).trigger("layout")):currWidth>1e3&&"large"!==currView&&(resizeForDesktop(),$(window).trigger("layout")),void 0!==map&&0==openPoints.length&&(centerOnLocation?map.setCenter(userLoc):map.setCenter(loc))}),$(window).trigger("resize");var t=navigator.userAgent.match(/(iPad|iPhone|iPod)/g);null!==t&&"large"==currView&&$("body").height($(window).height()),$(window).on("login_success",function(e){e.preventDefault(),$(".login-screen").fadeOut(300,function(){$(this).remove()})})});