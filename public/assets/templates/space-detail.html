<div class="space">
    <div class="title">
        <a href="#" class="close-view icon-close"><span class="hidden">Close</span></a>
        <h1>#{name}</h1>
        <small><span class="distance">#{distance}</span>les away</small>
    </div>
    <div class="gallery-container">
        <div class="gallery">
            <div class="gallery-images">
                #{images[<div style="background-image:url(#{value})" class="image"></div>]}
            </div>

        </div>
    </div>

    <div class="tabs">
        <ul>
            <li><a href="#info">Info</a></li>
            <li><a href="#tips">Tips</a></li>
            <li><a href="#map-#{id}">Map</a></li>
        </ul>
        <div class="tab-panel" id="info">

                <p>#{description}</p>
            <section class="section-facts">
                <h2>Key facts</h2>
                <ul>
                    <li><i class="icon-marker"></i><span>#{address}</span></li>
                    <li class="opening-times"><i class="icon-time-short"></i><span>#{opening_hours}</span></li>
                </ul>
            </section>
            <section class="lowlight section-facilities">
                <h2>Facilities</h2>
                <ul>
                    #{facilities[<li class="facility #{attr}"><i class="#{icon}"></i>#{value}</li>]}
                </ul>
            </section>
            <section class=" section-tags">
                <h2>Tags</h2>
                <ul>
                    #{admin_tag_list[<li class="tag admin #{attr}">#{value}</li>]}
                    #{user_tags_list[<li class="tag #{attr}">#{value}</li>]}
                </ul>
                <a href="#" class="add-tag btn">Add a tag</a>
            </section>
            <section class="lowlight section-contact">
                <h2>Contact</h2>
                <dl>
                    <dt>Website:</dt><dd><a href="#{url}" title="#{name}">#{url}</a></dd>
                    <dt>Phone:</dt><dd><a href="tel:#{phone_number}" title="call now">#{phone_number}</a></dd>
                    <dt>Twitter:</dt><dd><a href="https://twitter.com/#{twitter_screen_name}" title="#{twitter_screen_name}">#{twitter_screen_name}</a></dd>
                    <dt>Facebook:</dt><dd><a href="https://facebook.com/#{facebook_url}" title="#{facebook_url}">#{facebook_url}</a></dd>
                </dl>
            </section>
        </div>
        <div class="tab-panel" id="tips">
            <a class="btn add-tip">Add a tip</a>
            <div class="tips-container loading">
                <div class="loading-container">
                    <i class="icon-loading"></i><br />Loading Tips
                </div>
                <div class="no-tips hidden">
                    There are currently no tips for this space. Be the first to add a tip and inform others about this location.
                </div>
            </div>
        </div>
        <div class="map tab-panel" id="map-#{id}"></div>
    </div>
</div>
<script type="text/javascript">
console.log('#space-#{id}');
var $space = $('#space-#{id}');
//stick headers
/*if(currView == 'small') {
    setTimeout(function () {
        $space.find('.tabs>ul').sticky({topSpacing:$space.find('.title').outerHeight()});
    }, 500);
}*/

//close button
$space.find('.close-view').on('click', function(event) {
    event.preventDefault();
    if(currView == "large") {
        window.location.hash = '/';
        return;
    } else if(oldView !== undefined) {
        window.location.hash = oldView;
    } else {
        window.location.hash = '/';
    }

});

if($space.find('.distance').html() == "") {
    $space.find('.distance').parent().remove();
    $space.find('.title h1').css('margin-top', '10px');
}

//set up gallery
$space.find('.gallery>.gallery-images').width(($space.find('.gallery .image').length * 100) + '%');
//set up carousel
var images = $space.find('.gallery-images .image'),
    currImage = 0;
//add controls
if(images.length > 1) {
    $space.find('.gallery-container').append(
        $('<div />')
            .addClass('gallery-control back disabled')
            .append('<i class="icon-arrow-left"></i>')
            .on('click', function(event) {
                event.preventDefault();
                if(!$(this).hasClass('disabled')) {
                    currImage--;
                    $space.find('.gallery-container .gallery-control.forward').removeClass('disabled')
                    $space.find('.gallery-container .gallery').animate({scrollLeft:$space.find('.gallery-container .gallery').scrollLeft() + $(images[currImage]).position().left}, 300);
                    if(currImage - 1 < 0) {
                        $(this).addClass('disabled');
                    }
                }
            })
    ).append(
        $('<div />')
            .addClass('gallery-control forward ' + (images.length == 1 ? 'disabled' : ''))
            .append('<i class="icon-arrow-right"></i>')
            .on('click', function(event) {
                event.preventDefault();
                if(!$(this).hasClass('disabled')) {
                    currImage++;
                    console.log(currImage);
                    console.log($(images[currImage]).position().left);
                    $space.find('.gallery-container .gallery-control.back').removeClass('disabled')
                    $space.find('.gallery-container .gallery').animate({scrollLeft:$space.find('.gallery-container .gallery').scrollLeft() + $(images[currImage]).position().left}, 300);

                    if(currImage + 1 > images.length - 1) {
                        $(this).addClass('disabled');
                    }


                }
            })
    );
} else {
    $space.find('.gallery-container').height(0);
}
//set up tabs
$space.find('.tabs').tabs({
    activate: function(e, ui) {
        console.log($(ui.newPanel).attr('id'));
        if($(ui.newPanel).attr('id') == "map-#{id}") {
            $(ui.newPanel).height($(window).height() - ($space.find('.ui-tabs-nav').outerHeight(true) + $space.find('.title').outerHeight(true)))
            google.maps.event.trigger(localMap, 'resize');
            localMap.setCenter(m.getPosition());
            $(document).scrollTop($space.find('.tabs').position(true).top - $space.find('.title').outerHeight(true));
        }
        if($(ui.newPanel).attr('id') == "tips") {
            $space.find('.tips-container').css('min-height', $(window).height() - $space.find('.tips-container').offset().top);
        }

    }
});




var lat = Number(#{lat}),
    lng = Number(#{lng});

//set up map
if(lat !== null && lng !== null) {
    spaceMapOptions = {
        center: {'lat':lat, 'lng':lng},
        zoom: 18,
        disableDefaultUI: true
    }

    localMap = new google.maps.Map(document.getElementById('map-#{id}'), spaceMapOptions);

    var m;
    google.maps.event.trigger(localMap, 'resize');
    console.log(localMap);
    m = new google.maps.Marker({
        position: {'lat':lat, 'lng':lng},
        map:localMap,
        icon:markerSymbol
    });
    m.icon.fillColor = activeColor;
    m.icon.fillOpacity = 1;
    localMap.setCenter(m.getPosition());
} else {
    $space.find('a[href="#map-#{id}]"').parent('li').remove();
}

if(currView == 'large') {
    $space.find('a[href=#map-#{id}]').parent('li').hide(0);
    if(lat !== null && lng !== null) {
        map.setCenter({'lat':lat, 'lng':lng});
        map.setZoom(18);
        new google.maps.event.trigger(findMarkers(points, {'id':#{id}}).spaces[0].marker, 'click' );
        setTimeout(function() {
                points[openPoints[0]].mapSummary.close();
        }, 100)

    }
}

//load current tips
function loadTips() {
    $.ajax({
        url: 'https://uoc-spacefinder.herokuapp.com/spaces/#{id}/tips.json?callback=?',
        cache:false,
        dataType:'json',
        method:'GET'
    })
    .done(function(data) {
        $space.find('.tips-container').removeClass('loading').find('.loading-container').addClass('hidden');
        if(data.length > 0) {
            $space.find('.tip').remove();
            $(data).each(function(index) {
                var val = parseTemplate('spaceTip', data[index]);
                $space.find('.tips-container').append(val);
            });
            $space.find('.tip').each(function () {
                $(this).find('.timestamp').html(moment($(this).find('.timestamp').html(), "YYYY-MM-DD[T]HH:mm:ss.SSS[Z]").fromNow());
            });
        } else {
            $space.find('.no-tips').removeClass('hidden');
        }

    })
}
loadTips();


//tips

$space.find('.add-tip').on('click', function(event) {
    console.log('load tip screen');
    event.preventDefault();
    space = findMarkers(points, {'id':#{id}}).spaces[0];
    console.log(space);
    var space = $('<div />')
    .css('display', 'none')
    .attr('id', 'tip-#{id}')
    .data('space-id', '#{id}')
    .addClass('new-tip-container')
    .append(parseTemplate('addTip', space))
    .appendTo($space)
    .fadeIn(300, function() {
        $space.find('.space').css('display', 'none');
    });
});

//tags

$space.find('.add-tag').on('click', function(event) {
    console.log('load tag screen');
    event.preventDefault();
    space = findMarkers(points, {'id':#{id}}).spaces[0];
    console.log(space);
    var space = $('<div />')
    .css('display', 'none')
    .attr('id', 'tag-#{id}')
    .data('space-id', '#{id}')
    .addClass('new-tag-container')
    .append(parseTemplate('addTag', space))
    .appendTo($space)
    .fadeIn(300, function() {
        $space.find('.space').css('display', 'none');
    });
});

$(window).on('layout', function(event) {
    event.preventDefault();
    console.log('change layout');
    if(currView == 'large') {
        $space.find('a[href=#map-#{id}]').parent('li').hide(0);
        if(lat !== null && lng !== null) {
            map.setCenter({'lat':lat, 'lng':lng});
            //map.setZoom(18);
            new google.maps.event.trigger(findMarkers(points, {'id':#{id}}).spaces[0].marker, 'click' );
        }
        //$space.find('.tabs>ul').unstick();
    } else {
        $space.find('a[href=#map-#{id}]').parent('li').show(0);
        //$space.find('.tabs>ul').sticky({topSpacing:$space.find('.title').outerHeight()});
    }
});
</script>
