<div class="search-options-container">
    <div class="search-text">
        <input type="text" id="search_query" name="filters[search_query]" placeholder="Search for a space or keyword" />
        <a id="clear-search" class="btn secondary">Clear all</a>
    </div>
    <ul>
        <li><div class="header"><span class="title">I want to work...</span></div>
            <ul id="search-work">
                #{work[<li class="filter-option work #{attr}" data-id="#{attr}"><div><i class="icon-tick"></i><p>#{value}</p></div></li>]}
            </ul>
        </li>
        <li><div class="header"><span class="title">Atmosphere</span></div>
            <ul id="search-atmosphere">
                #{atmosphere[<li class="filter-option atmosphere #{attr}" data-id="#{attr}"><div><i class="icon-tick"></i><p>#{value}</p></div></li>]}
            </ul>
        </li>
        <li><div class="header"><span class="title">Noise levels</span></div>
            <ul  id="search-noise">
                #{noise[<li class="filter-option noise-level  #{title(attr="_")}" data-id="#{id}"><div><i class="#{title(icon)}"></i><p>#{title}</p></div></li>]}
            </ul>
        </li>
        <li><div class="header"><span class="title">Facilities</span></div>
            <ul id="search-facilities">
                #{facilities[<li class="filter-option facility #{attr}" data-id="#{attr}"><div><i class="#{icon}"></i><p>#{value}</p></div></li>]}
            </ul>
        </li>
        <!--li><div class="header"><span class="title">Tags</span></div>
        <ul id="search-tags">
        #{tags[<li class="filter-option #{name(attr="_")}" data-id="#{name}"><div><i class="icon-tick"></i><p>#{name}</p></div></li>]}
    </ul>
</li-->
</ul>
</div>
<a class="btn search-button"><i class="icon-search"></i>Search</a>

<script type="text/javascript">
$('.filter-option').on('click', function(event) {
    event.preventDefault();
    $(this).toggleClass('active');
    if(currView == 'large') {
        systemEvent = true;
        $('.search-button').click();
    }

});

$("#clear-search").on('click', function(event) {
    event.preventDefault();
    $('#search_query').val('');
    $('.filter-option').removeClass('active');
    $('.search-button').click();
});

$('.header').parents('li').addClass('expanded').end().append(
    $('<a />')
    .append($('<i />').addClass('icon-arrow-down'))
    .addClass('section-collapse')
    .addClass('expanded')
    //.text('collapse')
    .on('click', function(event) {
        event.preventDefault();
        if($(this).hasClass('expanded')) {
            //collapse
            //$(this).text('expand');
            $(this).find('i').removeAttr('class').addClass('icon-arrow-up');
            $(this).parents('li').find('>ul:first-of-type').stop().slideUp(300);
        } else {
            //expand
            //$(this).text('collapse');
            $(this).find('i').removeAttr('class').addClass('icon-arrow-down');
            $(this).parents('li').find('>ul:first-of-type').stop().slideDown(300);
        }
        $(this).toggleClass('expanded');
        $(this).parents('li').toggleClass('expanded');
    })
);

$('#search_query').on('keyup', function(event) {
    event.preventDefault();
    if(event.keyCode == 13) {
        $('.search-button').trigger('click');
        $(this).blur();
    }
});

$('.search-button').on('click', function(event) {
    exclude = {
        'exclusions':[],
        'total':0
    };
    $('.active[data-ignore="true"]').removeAttr('data-ignore');
    console.log(event);
    var $search = $(this);
    event.preventDefault();
    $search.height($search.height());
    $search.html('<i class="icon-loading"></i>');

    console.log('prep search');
    var searchString = prepSearch();
    loadSpaces({
        "queryString": searchString,
        "reset": false,
        //keepData:true,
        "clearSpaces":true,
        "callback": function() {


            if (event.isTrigger == undefined) {
                console.log('trigger - ', event.isTrigger);
                window.location.hash = '/list';
            }

            $search.html('<i class="icon-search"></i>Search');
            if(map !== null && map !== undefined) {
                map.setZoom(currentZoom);
                map.setCenter(currentLoc);
            }
        }
    })
});
function checkExpansions() {
    var totalExpansions = 0;
    if($('#search-noise .active').length > 0) {
        totalExpansions += 1;
    }
    if($('#search-atmosphere .active').length > 0) {
        totalExpansions += 1;
    }
    exclude.total = totalExpansions;
    console.info('-------------------------', totalExpansions)
}
function expandSearch() {
    console.log('expand search');
    var tempExclude = [];
    if($('#search-noise .active').length > 0 && exclude.exclusions.length >= 0) {
        $('#search-noise .active').attr('data-ignore', true);
        tempExclude.push('noise');
    }

    if(($('#search-atmosphere .active').length > 0 && $('#search-atmosphere .active[data-ignore="true"]').length == 0 && exclude.exclusions.length >= 1) || ($('#search-noise .active').length == 0 && exclude.exclusions.length >= 0)) {
        $('#search-atmosphere .active').attr('data-ignore', true);
        console.log('ignore atmosphere filters');
        console.log('prep search - ' + prepSearch(['noise, atmosphere']));
        tempExclude.push('atmosphere');
    }

    exclude.exclusions = tempExclude;

}
function prepSearch() {
    var query = '';

    console.info(exclude, exclude.exclusions.indexOf('atmosphere'));
    $('#search-work .active').each(function(index, el) {
        query += '&filters[' + $(this).data('id').replace(/-/g, '_') + '][]=true';
    });

    if (exclude.exclusions.indexOf('atmosphere') == -1) {
        $('#search-atmosphere .active').each(function(index, el) {
            query += '&filters[' + $(this).data('id').replace(/-/g, '_') + '][]=true';
        });
    }
    $('#search-facilities .active').each(function(index, el) {
        query += '&filters[' + $(this).data('id').replace(/-/g, '_') + '][]=true';
    });
    if (exclude.exclusions.indexOf('noise') == -1) {
        $('#search-noise .active').each(function(index, el) {
            query += '&filters[with_noise_ids][]=' + $(this).data('id');
        });
    }

    $('#search-tags .active').each(function(index, el) {
        query += '&filters[with_tag_names][]=' + $(this).data('id');
    });

    query += '&filters[search_query]=' + $('#search_query').val();
    console.info(query.substr(1));
    return query.substr(1);
}
</script>
